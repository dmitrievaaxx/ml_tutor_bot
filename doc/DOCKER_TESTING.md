# Инструкции по тестированию Docker

Данный документ содержит инструкции для тестирования Docker деплоя бота.

## Предварительные требования

- Docker установлен и запущен
- Файл `.env` создан и настроен с корректными токенами

## Создание .env файла

Если файл `.env` еще не создан, создайте его на основе примера:

```bash
# Windows (PowerShell)
Copy-Item .env.example .env

# Linux/Mac
cp .env.example .env
```

Затем отредактируйте `.env` и добавьте ваши реальные токены:

```bash
TELEGRAM_BOT_TOKEN=ваш_токен_от_botfather
OPENROUTER_API_KEY=ваш_ключ_от_openrouter
LLM_MODEL=mistralai/mistral-7b-instruct:free
LLM_TEMPERATURE=0.7
LLM_MAX_TOKENS=500
LOG_LEVEL=INFO
```

## Тестирование сборки Docker образа

### 1. Сборка образа

```bash
# С использованием Makefile
make docker-build

# Или напрямую
docker build -t ml-tutor-bot:latest .
```

**Ожидаемый результат:** Образ успешно собирается без ошибок.

### 2. Проверка созданного образа

```bash
docker images | grep ml-tutor-bot
```

**Ожидаемый результат:** Должна быть запись с именем `ml-tutor-bot` и тегом `latest`.

### 3. Запуск контейнера

```bash
# С использованием Makefile
make docker-run

# Или напрямую
docker run -d --name ml-tutor-bot --env-file .env ml-tutor-bot:latest
```

**Ожидаемый результат:** Контейнер запускается без ошибок.

### 4. Проверка логов контейнера

```bash
docker logs ml-tutor-bot
```

**Ожидаемый результат:** В логах должно быть сообщение:
```
INFO - Бот запущен и готов к работе
```

### 5. Тестирование бота

1. Откройте Telegram
2. Найдите вашего бота по username
3. Отправьте команду `/start`
4. Выберите уровень знаний
5. Отправьте тестовый вопрос, например: "Что такое машинное обучение?"

**Ожидаемый результат:** Бот должен ответить на вопрос.

### 6. Проверка логов после взаимодействия

```bash
docker logs ml-tutor-bot
```

**Ожидаемый результат:** В логах должны быть записи о запросах к LLM и ответах.

### 7. Остановка и очистка

```bash
# С использованием Makefile
make docker-stop

# Или напрямую
docker stop ml-tutor-bot
docker rm ml-tutor-bot
```

## Проверка файлов Docker

### Dockerfile
- ✅ Использует Python 3.11-slim образ
- ✅ Копирует только необходимые файлы (bot/, llm/, pyproject.toml)
- ✅ Устанавливает зависимости через uv
- ✅ Создает непривилегированного пользователя для безопасности
- ✅ Запускает бот через CMD

### .dockerignore
- ✅ Исключает .git, .env, .venv
- ✅ Исключает __pycache__, *.pyc
- ✅ Исключает тесты и документацию
- ✅ Уменьшает размер образа

### Makefile
- ✅ Команда `make docker-build` для сборки
- ✅ Команда `make docker-run` для запуска
- ✅ Команда `make docker-stop` для остановки
- ✅ Команда `make help` для справки

## Возможные проблемы и решения

### Проблема: Образ не собирается

**Решение:** Убедитесь, что:
- Docker запущен
- Вы находитесь в корне проекта
- Файл `Dockerfile` существует и не поврежден

### Проблема: Контейнер не запускается

**Решение:** Проверьте:
- Файл `.env` существует и содержит корректные токены
- Порт не занят другим контейнером
- Логи: `docker logs ml-tutor-bot`

### Проблема: Бот не отвечает в Telegram

**Решение:** Проверьте:
- `TELEGRAM_BOT_TOKEN` корректен
- `OPENROUTER_API_KEY` корректен
- Логи контейнера на наличие ошибок

## Результаты тестирования

После прохождения всех тестов:
- ✅ Docker образ собирается успешно
- ✅ Контейнер запускается без ошибок
- ✅ Бот работает в контейнере
- ✅ Логирование функционирует корректно
- ✅ Все команды Makefile работают

